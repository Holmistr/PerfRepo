<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core" xmlns:c="http://java.sun.com/jstl/core"
	xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:rich="http://richfaces.org/rich" xmlns:a4j="http://richfaces.org/a4j"
	xmlns:jsflot="http://www.jsflot.org/taglib/jsflot">
<h:body>

	<f:metadata>

		<f:event type="preRenderView" listener="#{metricReportBean.preRender}" />
	</f:metadata>
	<ui:composition template="/layout/template.xhtml">
		<ui:define name="head">
			<jsflot:resources />
		</ui:define>
		<ui:define name="title">Metric values</ui:define>
		<ui:define name="content">
			<h1>Metric report</h1>
			<a href="#{metricReportBean.linkToReport}">Permanent link to report</a>
			<h:form id="reportForm">
				<h2>Basic parameters</h2>
				<table class="proptable">
					<tr>
						<td class="label"><h:outputText value="#{entityStrings.Test_uid}" /></td>
						<td><h:selectOneMenu value="#{metricReportBean.selectedTestId}" rendered="#{!metricReportBean.testUidDisabled}">
								<f:selectItems styleClass="input-text" value="#{metricReportBean.selectionTests}" var="item" itemLabel="#{item.uid}" itemValue="#{item.id}" />
							</h:selectOneMenu> <h:outputText value="#{metricReportBean.selectedTest.uid}" rendered="#{metricReportBean.testUidDisabled}" /></td>
					</tr>
					<h:panelGroup rendered="#{metricReportBean.testUidDisabled}">
						<tr>
							<td class="label"><h:outputText value="#{entityStrings.TestExecutionParameter_paramName}" /></td>
							<td><h:selectOneMenu value="#{metricReportBean.selectedParam}" rendered="#{!metricReportBean.execParamDisabled}">
									<f:selectItems value="#{metricReportBean.selectionParams}" var="item" itemLabel="#{item}" itemValue="#{item}" />
								</h:selectOneMenu> <h:outputText value="#{metricReportBean.reportSelectedParam}" rendered="#{metricReportBean.execParamDisabled}" /></td>
						</tr>
					</h:panelGroup>
				</table>
				<h:panelGroup rendered="#{metricReportBean.testUidDisabled and metricReportBean.execParamDisabled}">
					<h2>Data series</h2>
					<rich:dataTable id="seriesTable" styleClass="table table-bordered table-striped editableEntryTable" value="#{metricReportBean.seriesSpecs}"
						var="seriesItem">
						<rich:column>
							<f:facet name="header">Series name</f:facet>
							<h:inputText value="#{seriesItem.name}" />
						</rich:column>
						<rich:column>
							<f:facet name="header">Metric</f:facet>
							<h:selectOneMenu value="#{seriesItem.selectedMetricId}">
								<f:selectItems value="#{metricReportBean.selectionMetrics}" var="metricItem" itemLabel="#{metricItem.name}" itemValue="#{metricItem.id}" />
							</h:selectOneMenu>
						</rich:column>
						<rich:column>
							<f:facet name="header">Tags</f:facet>
							<h:inputText value="#{seriesItem.selectedTags}" />
						</rich:column>
						<rich:column>
							<f:facet name="header"></f:facet>
							<h:commandLink styleClass="btn btn-primary btn-small" action="#{metricReportBean.removeSeries(seriesItem)}" alt="Remove" title="Remove">
								<i class="icon-minus"></i>
							</h:commandLink>
						</rich:column>
					</rich:dataTable>
				</h:panelGroup>

				<h:commandLink styleClass="btn btn-primary btn-small" action="#{metricReportBean.redraw}" alt="Redraw" title="Redraw">
					<i class="icon-refresh"></i> Redraw
				</h:commandLink>
				<h:commandLink styleClass="btn btn-primary btn-small" action="#{metricReportBean.addSeries}" alt="Add series" title="Add series"
					rendered="#{metricReportBean.testUidDisabled and metricReportBean.execParamDisabled}">
					<i class="icon-plus"></i> Add series
				</h:commandLink>

				<h:panelGroup id="chartPanel" rendered="#{metricReportBean.chartVisible}">
					<script type="text/javascript">
            $.noConflict();
         </script>
					<h2>
						<h:outputText value="#{strings.metricReport_chart}" />
					</h2>
					<jsflot:flotChart id="metricChart" value="#{metricReportBean.chartData}" height="400" width="800" mode="Series" title="#{strings.metricReport_chartTitle}"
						chartType="line" showTooltip="true" yaxisMinValue="#{metricReportBean.chart.yaxisMinValue}" yaxisMaxValue="#{metricReportBean.chart.yaxisMaxValue}"
						showXaxisLabels="true" yaxisTitle="#{metricReportBean.chart.yaxisTitle}" xaxisTitle="#{metricReportBean.chart.xaxisTitle}" tooltipFollowMouse="true"
						chartClickable="true" actionListener="#{metricReportBean.chartActionListener}" reRender="dataPointPanel">
					</jsflot:flotChart>
				</h:panelGroup>

				<fieldset>
					<legend> Statistics </legend>
					<h:outputLabel class="detail-label">Min. value</h:outputLabel>
					<div class="detail-value">#{metricReportBean.minValueFmt}</div>
					<h:outputLabel class="detail-label">Max. value</h:outputLabel>
					<div class="detail-value">#{metricReportBean.maxValueFmt}</div>
					<h:outputLabel class="detail-label">Range</h:outputLabel>
					<div class="detail-value">#{metricReportBean.range}</div>
					<h:outputLabel class="detail-label">Found values</h:outputLabel>
					<div class="detail-value">#{metricReportBean.numValues}</div>
					<h:outputLabel class="detail-label">Normalize</h:outputLabel>
					<div class="detail-value">
						<h:selectBooleanCheckbox id="checkNormalize" value="#{metricReportBean.normalize}" immediate="true" disabled="false" />
					</div>
				</fieldset>
				<h:panelGroup id="dataPointPanel">
					<h:panelGroup rendered="#{metricReportBean.dataPointExecId != 'N/A'}">
						<fieldset>
							<legend> Selected data point </legend>
							<h:outputLabel class="detail-label">#{metricReportBean.reportSelectedParam}</h:outputLabel>
							<div class="detail-value">#{metricReportBean.dataPointParam}</div>
							<h:outputLabel class="detail-label">Metric value</h:outputLabel>
							<div class="detail-value">#{metricReportBean.dataPointValue}</div>
							<h:outputLabel class="detail-label">Exec ID</h:outputLabel>
							<div class="detail-value">
								<a href="/repo/exec/#{metricReportBean.dataPointExecId}">#{metricReportBean.dataPointExecId}</a>
								<!-- TODO: if this could be ajax button that would be great -->
								<h:commandButton action="#{teComparatorSession.add(metricReportBean.dataPointExecIdLong)}" alt="Add to comparison" title="Add to comparison"
									value="Add to comparison" />
							</div>
						</fieldset>
					</h:panelGroup>
				</h:panelGroup>

				<h:panelGroup id="problemPointsPanel" rendered="#{metricReportBean.problematicDataPointsVisible}">
					<h2>Problematic data points</h2>
					<rich:dataTable id="problemPointsTable" value="#{metricReportBean.problematicDatapoints}" var="item">


						<rich:column sortable="true" sortOrder="#{metricReportBean.sortsOrders['paramValue']}" sortBy="#{item.param}">
							<f:facet name="header">
								<a4j:commandLink value="#{strings.ProblematicPoints_ParameterValue}" render="problemPointsTable" action="#{metricReportBean.sort()}">
									<f:param name="sortProperty" value="paramValue" />
									<f:ajax render="problemPointsTable" />
								</a4j:commandLink>
							</f:facet>
							<h:outputText value="#{item.param}" />
						</rich:column>

						<rich:column sortable="true" sortOrder="#{metricReportBean.sortsOrders['execId']}" sortBy="#{item.execId}">
							<f:facet name="header">
								<a4j:commandLink value="#{strings.ProblematicPoints_TestExecutionId}" render="problemPointsTable" action="#{metricReportBean.sort()}">
									<f:param name="sortProperty" value="execId" />
									<f:ajax render="problemPointsTable" />
								</a4j:commandLink>
							</f:facet>
							<a href="/repo/exec/#{item.execId}">#{item.execId}</a>
						</rich:column>

						<rich:column sortable="true" sortOrder="#{metricReportBean.sortsOrders['problemType']}" sortBy="#{item.problemType}">
							<f:facet name="header">
								<a4j:commandLink value="Problem type" render="problemPointsTable" action="#{metricReportBean.sort()}">
									<f:param name="sortProperty" value="problemType" />
									<f:ajax render="problemPointsTable" />
								</a4j:commandLink>
							</f:facet>
						#{item.problemType}
					</rich:column>

					</rich:dataTable>
				</h:panelGroup>
			</h:form>
		</ui:define>
	</ui:composition>
</h:body>
</html>
